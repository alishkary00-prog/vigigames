// admin.js — آخرین نسخه برای VIGIGAMES Dark Theme
const PASSWORD = "13822";
let projects = [];
let editingId = null;

// توابع کمکی (باید در Scope جهانی باشند تا onclick کار کند)
function togglePassword() {
    const input = document.getElementById("adminPass");
    const btn = document.getElementById("togglePass");
    if (input.type === "password") {
        input.type = "text";
        btn.textContent = "مخفی";
    } else {
        input.type = "password";
        btn.textContent = "نمایش";
    }
}

function renderList() {
    const list = document.getElementById("projectsList");
    if (!list) return; // چک کردن برای اطمینان
    
    list.innerHTML = "<h3>لیست پروژه‌های ثبت شده:</h3>";
    
    projects.forEach((p, i) => {
        const statusText = p.status === "completed" ? "تکمیل شده" :
                           p.status === "in-progress" ? "در حال ساخت" : "لغو شده";
        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `
            <div class="item-info">
                <h4>${p.name} (${statusText})</h4>
            </div>
            <div class="project-actions">
                <button class="edit" onclick="editProject(${i})">ویرایش</button>
                <button class="delete" onclick="deleteProject(${i})">حذف</button>
            </div>
        `;
        list.appendChild(item);
    });
}

function login() {
    if (document.getElementById("adminPass").value === PASSWORD) {
        // تغییر وضعیت نمایش
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        
        // ذخیره وضعیت ورود در حافظه مرورگر
        localStorage.setItem("isLoggedIn", "true");
        renderList();
    } else {
        document.getElementById("errorMsg").style.display = "block";
    }
}

function logout() {
    // تغییر وضعیت نمایش
    document.getElementById("adminPanel").style.display = "none";
    document.getElementById("loginScreen").style.display = "flex";
    
    // پاکسازی
    document.getElementById("adminPass").value = "";
    document.getElementById("errorMsg").style.display = "none";
    localStorage.removeItem("isLoggedIn");
}

function editProject(i) {
    editingId = i;
    const p = projects[i];
    document.getElementById("pName").value = p.name;
    document.getElementById("pDesc").value = p.desc;
    document.getElementById("pImage").value = p.image;
    document.getElementById("pStatus").value = p.status;
    document.getElementById("submitBtn").textContent = "بروزرسانی پروژه";
}

function deleteProject(i) {
    if (confirm("واقعاً می‌خوای این پروژه حذف بشه؟")) {
        projects.splice(i, 1);
        localStorage.setItem("vigigames_projects", JSON.stringify(projects));
        renderList();
    }
}


// ** تضمین اجرای کد پس از بارگذاری کامل DOM **
document.addEventListener("DOMContentLoaded", function() {
    
    // 1. بارگذاری پروژه‌ها از localStorage
    const saved = localStorage.getItem("vigigames_projects");
    if (saved) {
        try { projects = JSON.parse(saved); }
        catch(e) { projects = []; }
    }
    
    // 2. چک کردن وضعیت ورود هنگام لود صفحه
    if (localStorage.getItem("isLoggedIn") === "true") {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        renderList();
    }
    
    // 3. ثبت/ویرایش پروژه
    document.getElementById("projectForm")?.addEventListener("submit", function(e) {
        e.preventDefault();
        
        const newProj = {
            name: document.getElementById("pName").value.trim(),
            desc: document.getElementById("pDesc").value.trim(),
            image: document.getElementById("pImage").value.trim() || "https://placehold.co/800x600/111/00ffff?text=VIGIGAMES",
            status: document.getElementById("pStatus").value
        };

        if (!newProj.name || !newProj.desc || !newProj.image) {
            alert("همه فیلدها اجباریه!");
            return;
        }

        if (editingId === null) {
            projects.push(newProj);
        } else {
            projects[editingId] = newProj;
            editingId = null;
            document.getElementById("submitBtn").textContent = "ثبت پروژه";
        }

        localStorage.setItem("vigigames_projects", JSON.stringify(projects));
        renderList();
        
        // پاکسازی فرم
        document.getElementById("projectForm").reset();
    });

});
